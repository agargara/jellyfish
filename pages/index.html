<!DOCTYPE html>
<html>
<head>
  <title>Jellyfish</title>
  <script src="rhizome/rhizome.js"></script>
  <script src="js/jquery-2.1.0.min.js"></script>
  <script src="js/nexusUI.js"></script>
  <script src="js/Tone.js"></script>
  <link rel="stylesheet" type="text/css" href="css/styles.css" />
  <script>
    var myId;
    $(function() {
      
      t = new Tone.Oscillator(340, "sine");
      t.start()
      t.volume.value = -100
      t.toMaster()


      rhizome.start(function(err) {
        if (err) {
          $('body').html('client failed starting : ' + err)
          throw err
        }

        $('#send').submit(function(event) {
          event.preventDefault()
          var address = $('#address').val()
            , args = $('#args').val()
          if (args.length)
            args = args.split(' ').map(function(arg) { return JSON.parse(arg) })
          else args = []
          rhizome.send(address, args)
        })
        // Make a unique ID based on rhizome id.
        myId = rhizome.id;

        // We want to receive all the messages, so we subscribe to '/'
        rhizome.send('/sys/subscribe', ['/'])

        // Get user IDs.
        rhizome.send('/getPlayers', ['/'])
      })
      var userList = {}; // keep track of connected users.
      rhizome.on('message', function(address, args) {
        $("#message").html(address + ", " + args);
        switch (address) {
          case '/sys/connections//':
            break;
          case '/getPlayers':
            rhizome.send('/addPlayer', [myId]);
            break;
          case '/addPlayer':
            userList[args] = true;
            var userStrings = [];
            for (var user in userList){
              userStrings.push(user.substring(0,4));
            }
            $("#userList").html(userStrings.join(", "));
            break;
          case '/slider1':
            t.volume.value = nx.scale(args[0],0,1,-90,0);
            break;
          case '/freq':
            t.frequency.value = args[0];
            break;
          default: 
            console.log(address + " ::: " + args);
        }
      })

      rhizome.on('connected', function() {
        console.log('connected!')
      })

      rhizome.on('connection lost', function() {
        console.log('connection lost!')
      })

      rhizome.on('queued', function() {
        console.log('queued!')
      })

    })

    nx.onload = function() {
      meter1.setup(Tone.context,t)
    }
  </script>
</head>

<body>
  <canvas nx="meter" style="height:300px;width:100px"></canvas>
  <hr>
  Latest message: <span id="message"></span><br>
  Connected users: <span id="userList"></span>
</body>

</html>
